<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check-in — Carregando evento...</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root {
      --bg: #0f172a;
      --surface: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --success: #0f766e;
      --danger: #b91c1c;
      --border: #e2e8f0;
      --shadow: 0 20px 45px rgba(15, 23, 42, 0.24);
      --radius: 18px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text);
      min-height: 100vh;
      background: radial-gradient(circle at top right, #1e3a8a 0%, var(--bg) 42%, #020617 100%);
      padding: max(16px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(18px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left));
    }

    .container {
      width: 100%;
      max-width: 1060px;
      margin: 0 auto;
      display: grid;
      gap: 12px;
    }

    .hero {
      color: #f8fafc;
      text-align: center;
      padding: 4px;
    }

    .brand {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
      margin-bottom: 8px;
    }

    .brandMark img {
      width: 52px;
      height: 52px;
      object-fit: contain;
    }

    .hero h1 {
      margin: 0;
      font-size: clamp(1.55rem, 5vw, 2.3rem);
      line-height: 1.2;
    }

    .hero p {
      margin: 8px 0 0;
      color: #cbd5e1;
      font-size: 0.98rem;
      line-height: 1.45;
    }

    .card {
      background: linear-gradient(160deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid rgba(148, 163, 184, 0.28);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    label {
      display: block;
      font-size: 0.95rem;
      font-weight: 700;
      color: #334155;
    }

    input,
    button {
      width: 100%;
      min-height: 46px;
      margin-top: 7px;
      padding: 11px 13px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 16px;
      transition: border-color .2s, box-shadow .2s, transform .2s;
    }

    input:focus {
      outline: none;
      border-color: color-mix(in srgb, var(--primary) 65%, white);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
    }

    button {
      width: auto;
      cursor: pointer;
      border: 0;
      color: #fff;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);
    }

    button:hover {
      transform: translateY(-1px);
      background: linear-gradient(135deg, var(--primary-hover) 0%, #2563eb 100%);
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .row > div {
      flex: 1;
      min-width: 220px;
    }

    .table-wrap {
      margin-top: 10px;
      width: 100%;
      overflow-x: auto;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      background: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      border-bottom: 1px solid #edf2f7;
      padding: 10px;
      text-align: left;
      vertical-align: middle;
      white-space: nowrap;
    }

    th {
      font-size: .85rem;
      color: #334155;
      text-transform: uppercase;
      letter-spacing: .02em;
      background: #f8fafc;
    }

    tr:last-child td { border-bottom: 0; }

    .muted { color: var(--muted); font-size: 14px; }

    #msg {
      min-height: 24px;
      margin: 0;
      font-weight: 700;
    }

    .err {
      color: var(--danger);
      background: #fee2e2;
      border: 1px solid #fecaca;
      border-radius: 10px;
      padding: 8px 10px;
    }

    .ok {
      color: var(--success);
      background: #ccfbf1;
      border: 1px solid #99f6e4;
      border-radius: 10px;
      padding: 8px 10px;
    }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 12px;
      margin-right: 6px;
      background: #fff;
    }

    .present {
      background: #ecfdf5;
      border-color: #86efac;
    }

    .absent {
      background: #fef2f2;
      border-color: #fecaca;
    }

    .click { cursor: pointer; }
    .small { font-size: 13px; }
    .right { display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap; }

    @media (max-width: 640px) {
      .card {
        padding: 14px;
        border-radius: 14px;
      }

      .right {
        justify-content: stretch;
      }

      button {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <main class="container">
    <section class="hero">
      <div class="brand">
        <div class="brandMark">
          <img src="logo-modern-noglow.png" alt="Casais 2 em 1" />
        </div>
      </div>
      <h1 id="title">Check-in — Carregando evento...</h1>
      <p>Clique no casal para marcar como presente/ausente.</p>
    </section>

    <p id="msg"></p>

    <div class="card">
      <div class="row">
        <div>
          <label>Buscar (nome)</label>
          <input id="search" placeholder="Ex: Maria" />
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="right">
            <button id="btnReload">Recarregar</button>
          </div>
        </div>
      </div>

      <div style="margin-top:10px">
        <span class="pill" id="pillTotal">Total: —</span>
        <span class="pill present" id="pillPresent">Presentes: —</span>
        <span class="pill absent" id="pillAbsent">Ausentes: —</span>
      </div>
    </div>

    <div class="card">
      <div id="tableWrap" class="table-wrap"></div>
      <p class="muted small" style="margin-top:10px">Dica: use a busca para acelerar.</p>
    </div>
  </main>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.95.3/+esm";

    const SUPABASE_URL = "https://nuqcefxwarrjehvhdoug.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51cWNlZnh3YXJyamVodmhkb3VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NzE1NzUsImV4cCI6MjA4NjM0NzU3NX0.xLugRmdl6UKVsMZnDepBlFndh4vGVMnptuloFZC28Mc";

    // Público: sem sessão
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
    });

    const msg = document.getElementById("msg");
    const titleEl = document.getElementById("title");
    const searchInput = document.getElementById("search");
    const btnReload = document.getElementById("btnReload");

    const pillTotal = document.getElementById("pillTotal");
    const pillPresent = document.getElementById("pillPresent");
    const pillAbsent = document.getElementById("pillAbsent");

    const tableWrap = document.getElementById("tableWrap");

    const params = new URLSearchParams(location.search);
    const EVENT_ID = params.get("event");

    let allRows = [];

    function setMsg(text, kind="") {
      msg.className = kind ? kind : "";
      msg.textContent = text || "";
    }

    function escapeHtml(s){
      return (s ?? "").toString().replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function renderStats(rows) {
      const total = rows.length;
      const present = rows.filter(r => r.is_present).length;
      const absent = total - present;
      pillTotal.textContent = `Total: ${total}`;
      pillPresent.textContent = `Presentes: ${present}`;
      pillAbsent.textContent = `Ausentes: ${absent}`;
    }

    function getFiltered() {
      const q = (searchInput.value || "").trim().toLowerCase();
      if (!q) return allRows;
      return allRows.filter(r => (r.couple_name || "").toLowerCase().includes(q));
    }

    function renderTable() {
      const rows = getFiltered();
      renderStats(rows);

      const htmlRows = rows.map(r => {
        const status = r.is_present ? "✅ Presente" : "⬜ Ausente";
        const cls = r.is_present ? "present" : "absent";
        const checkedAt = r.checked_in_at ? new Date(r.checked_in_at).toLocaleString() : "—";

        return `
          <tr class="click ${cls}" data-id="${r.id}" data-present="${r.is_present}">
            <td><strong>${escapeHtml(r.couple_name)}</strong></td>
            <td>${escapeHtml(r.wedding_date ?? "—")}</td>
            <td>${status}<br/><span class="muted small">Check-in: ${checkedAt}</span></td>
          </tr>
        `;
      }).join("");

      tableWrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Casal</th>
              <th>Data casamento</th>
              <th>Presença</th>
            </tr>
          </thead>
          <tbody>
            ${htmlRows || "<tr><td colspan='3' class='muted'>Nenhum resultado.</td></tr>"}
          </tbody>
        </table>
      `;

      tableWrap.querySelectorAll("tr[data-id]").forEach(tr => {
        tr.addEventListener("click", async () => {
          const id = tr.dataset.id;
          const wasPresent = tr.dataset.present === "true";
          const newPresent = !wasPresent;

          // UI otimista
          tr.dataset.present = String(newPresent);
          const row = allRows.find(x => x.id === id);
          if (row) {
            row.is_present = newPresent;
            row.checked_in_at = newPresent ? new Date().toISOString() : null;
          }
          renderTable();

          // Atualiza no banco via RPC pública
          const { data, error } = await supabase.rpc("set_presence_public", {
            p_registration_id: id,
            p_is_present: newPresent
          });

          if (error || !data?.ok) {
            // desfaz se falhar
            if (row) {
              row.is_present = wasPresent;
              // não sabemos o checked_in_at anterior sem recarregar, então só volta o boolean
            }
            renderTable();
            setMsg("Falha ao atualizar. Recarregue e tente novamente.", "err");
          } else {
            setMsg("Atualizado.", "ok");
            setTimeout(() => setMsg(""), 800);
          }
        });
      });
    }

    async function loadEventTitle() {
      if (!EVENT_ID) return;

      const { data } = await supabase
        .from("events")
        .select("title")
        .eq("id", EVENT_ID)
        .maybeSingle();

      const eventName = data?.title?.trim() || "Evento";
      const finalTitle = `Check-in — ${eventName}`;
      document.title = finalTitle;
      titleEl.textContent = finalTitle;
    }

    async function loadRegistrations() {
      if (!EVENT_ID) {
        setMsg("Link inválido: faltou ?event=UUID_DO_EVENTO", "err");
        tableWrap.innerHTML = "";
        return;
      }

      setMsg("");
      tableWrap.innerHTML = "<p class='muted'>Carregando...</p>";

      const { data, error } = await supabase
        .from("registrations_checkin")
        .select("id,couple_name,wedding_date,is_present,checked_in_at,created_at")
        .eq("event_id", EVENT_ID)
        .order("couple_name", { ascending: true });

      if (error) {
        tableWrap.innerHTML = "<p class='err'>Erro ao carregar lista.</p>";
        return;
      }

      allRows = data ?? [];
      renderTable();
    }

    searchInput.addEventListener("input", renderTable);
    btnReload.addEventListener("click", loadRegistrations);

    await loadEventTitle();
    await loadRegistrations();
  </script>
</body>
</html>
