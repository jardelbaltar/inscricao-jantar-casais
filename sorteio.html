<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>üé¨ Grande Sorteio</title>

<style>
:root{
  --bg1:#0b1220;
  --bg2:#090f1c;
  --gold:#ffd700;
  --accent:#6ae4ff;
  --text:#ffffff;
}

body{
  margin:0;
  font-family:system-ui,Arial;
  background:
    radial-gradient(circle at 50% 20%, rgba(255,215,0,.15), transparent 40%),
    radial-gradient(circle at 50% 80%, rgba(106,228,255,.15), transparent 40%),
    linear-gradient(180deg,var(--bg1),var(--bg2));
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  overflow:hidden;
}

.container{
  text-align:center;
  width:100%;
  max-width:1000px;
}


.brand{
  display:flex;
  align-items:center;
  justify-content:center;
  margin-bottom:12px;
}

.brandMark img{
  width:52px;
  height:52px;
  object-fit:contain;
}

h1{
  font-size:34px;
  margin-bottom:10px;
  letter-spacing:1px;
}

.countdown{
  font-size:120px;
  font-weight:900;
  height:150px;
}

#winner{
  font-size:60px;
  font-weight:900;
  margin:20px 0;
  min-height:80px;
  text-shadow:0 0 30px var(--gold);
}

.history{
  position:absolute;
  right:20px;
  top:20px;
  width:260px;
  background:rgba(0,0,0,.5);
  padding:15px;
  border-radius:12px;
}

.history h3{
  margin-top:0;
  font-size:16px;
  color:var(--gold);
}

.history ul{
  padding-left:18px;
  font-size:14px;
}

.controls{
  margin-top:30px;
  display:flex;
  gap:20px;
  justify-content:center;
  flex-wrap:wrap;
}

button{
  padding:14px 24px;
  font-size:18px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  background:linear-gradient(90deg,#ffd700,#ff8c00);
  color:black;
  font-weight:bold;
}

button:disabled{opacity:.5}
</style>
</head>

<body>

<div class="history">
  <h3>üèÜ Vencedores</h3>
  <ul id="historyList"></ul>
</div>

<div class="container">
  <div class="brand">
    <div class="brandMark">
      <img src="logo-modern-noglow.png" alt="Casais 2 em 1">
    </div>
  </div>
  <h1>üé¨ GRANDE MOMENTO DO SORTEIO üéÅ</h1>

  <div class="countdown" id="countdown"></div>
  <div id="winner">Preparem-se...</div>

  <div class="controls">
    <button id="drawBtn">üéâ Sortear Agora</button>
    <button id="resetBtn">üîÑ Resetar</button>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.95.3/+esm";

const SUPABASE_URL = "https://nuqcefxwarrjehvhdoug.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51cWNlZnh3YXJyamVodmhkb3VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NzE1NzUsImV4cCI6MjA4NjM0NzU3NX0.xLugRmdl6UKVsMZnDepBlFndh4vGVMnptuloFZC28Mc";

const supabase=createClient(SUPABASE_URL,SUPABASE_ANON_KEY,{auth:{persistSession:false}});

const params=new URLSearchParams(location.search);
const EVENT_ID=params.get("event");

const winnerEl=document.getElementById("winner");
const drawBtn=document.getElementById("drawBtn");
const resetBtn=document.getElementById("resetBtn");
const countdownEl=document.getElementById("countdown");
const historyList=document.getElementById("historyList");

let participants=[];
let winners=[];

async function load(){
  const {data}=await supabase
    .from("registrations_checkin")
    .select("id,couple_name,is_present")
    .eq("event_id",EVENT_ID);

  participants=data||[];
}

function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

async function startCountdown(){
  for(let i=3;i>0;i--){
    countdownEl.textContent=i;
    await sleep(1000);
  }
  countdownEl.textContent="";
}

function confetti(){
  for(let i=0;i<150;i++){
    const el=document.createElement("div");
    el.style.position="fixed";
    el.style.width="6px";
    el.style.height="6px";
    el.style.background=`hsl(${Math.random()*360},100%,60%)`;
    el.style.left=Math.random()*100+"vw";
    el.style.top="-10px";
    el.style.animation=`fall ${2+Math.random()*3}s linear`;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),5000);
  }
}

const style=document.createElement("style");
style.innerHTML=`@keyframes fall{to{transform:translateY(110vh) rotate(720deg);}}`;
document.head.appendChild(style);

async function draw(){
  if(participants.length===0)return;

  drawBtn.disabled=true;

  await startCountdown();

  let pool=participants.filter(p=>!winners.includes(p.id));
  if(pool.length===0) pool=[...participants];

  let speed=50;
  let loops=40;

  for(let i=0;i<loops;i++){
    const r=pool[Math.floor(Math.random()*pool.length)];
    winnerEl.textContent=r.couple_name;
    await sleep(speed);
    speed+=10; // desacelera√ß√£o progressiva
  }

  const final=pool[Math.floor(Math.random()*pool.length)];
  winnerEl.textContent="üèÜ "+final.couple_name+" üèÜ";
  winners.push(final.id);

  const li=document.createElement("li");
  li.textContent=final.couple_name;
  historyList.appendChild(li);

  confetti();

  drawBtn.disabled=false;
}

resetBtn.addEventListener("click",()=>{
  winners=[];
  historyList.innerHTML="";
  winnerEl.textContent="Pronto para novo sorteio!";
});

drawBtn.addEventListener("click",draw);

await load();
</script>

</body>
</html>
