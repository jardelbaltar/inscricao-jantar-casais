<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Painel ‚Äî Estat√≠sticas do Jantar</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0a1a2f;
      --text:#eaf0ff;
      --muted:#9db0d1;
      --line:rgba(255,255,255,.08);
      --accent:#6ae4ff;
      --accent2:#8b5cf6;
      --good:#2cff9a;
      --warn:#ffcc66;
      --bad:#ff5d7a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(106,228,255,.18), transparent 55%),
        radial-gradient(1000px 700px at 85% 15%, rgba(139,92,246,.16), transparent 55%),
        radial-gradient(900px 650px at 50% 95%, rgba(44,255,154,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    header{
      max-width:1200px;
      margin:20px auto 10px;
      padding:0 16px;
      display:flex;
      gap:14px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .title{display:flex;flex-direction:column;gap:6px}

    .titleWrap{display:flex;align-items:center;gap:12px}
    .brandMark img{
      width:52px;
      height:52px;
      object-fit:contain;
    }
    h1{margin:0;font-size:22px;letter-spacing:.2px;font-weight:800}
    .sub{
      color:var(--muted);
      font-size:13px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background:var(--good);
      box-shadow: 0 0 0 3px rgba(44,255,154,.15);
    }
    .wrap{
      max-width:1200px;
      margin:0 auto 24px;
      padding:0 16px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 980px){ .wrap{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:14px;
      overflow:hidden;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .grid2{grid-template-columns:1fr} }
    .card h2{
      margin:0 0 8px;
      font-size:14px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.2px;
    }
    .big{
      font-size:26px;
      font-weight:900;
      margin:0;
      line-height:1.15;
      letter-spacing:.2px;
    }
    .value{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
    .badge{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
    }
    .list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .row{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(0,0,0,.18);
    }
    .name{display:flex;gap:10px;align-items:center;min-width:0}
    .rank{
      width:28px;height:28px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:12px;
      background: linear-gradient(135deg, rgba(106,228,255,.35), rgba(139,92,246,.25));
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .name span{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:800;
    }
    .time{font-weight:900;color: var(--accent);flex:0 0 auto}
    .muted{color:var(--muted);font-size:13px;margin-top:6px}
    .barWrap{
      margin-top:10px;
      height:12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      overflow:hidden;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: width .6s ease;
    }
    .footer{
      max-width:1200px;
      margin:0 auto 24px;
      padding:0 16px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:10px;
    }
    .err{
      color:var(--bad);
      font-weight:800;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,93,122,.25);
      background: rgba(255,93,122,.10);
    }
    canvas{max-height:380px}
  </style>
</head>

<body>
  <header>
    <div class="titleWrap">
      <div class="brandMark">
        <img src="/logo-modern-noglow.png" alt="Casais 2 em 1">
      </div>
      <div class="title">
        <h1 id="eventTitle">Painel [nome do evento]</h1>
        <div class="sub">
          <span class="chip"><span class="dot"></span><span id="status">Atualizando‚Ä¶</span></span>
          <span class="chip" id="chipCounts">Carregando‚Ä¶</span>
          <span class="chip" id="chipMode">Modo: Inscritos</span>
        </div>
      </div>
    </div>
    <div class="sub">
      <span class="chip">Auto refresh: 30s</span>
      <span class="chip" id="lastUpdated">‚Äî</span>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <h2>üìä Distribui√ß√£o por tempo de casado</h2>
      <div class="muted">Faixas em anos (0‚Äì4, 5‚Äì9, ‚Ä¶, 30+).</div>
      <div style="height:14px"></div>
      <canvas id="chart"></canvas>
    </div>

    <div class="grid2">
      <div class="card">
        <h2>üèÜ Casal com mais tempo de casado</h2>
        <div id="top1"><div class="muted">Carregando‚Ä¶</div></div>
      </div>

      <div class="card">
        <h2>üíç Casal mais recente</h2>
        <div id="youngest"><div class="muted">Carregando‚Ä¶</div></div>
      </div>

      <div class="card">
        <h2>üìà M√©dia de tempo de casamento</h2>
        <div id="avg"><div class="muted">Carregando‚Ä¶</div></div>
      </div>

      <div class="card">
        <h2>üë• Presen√ßa</h2>
        <div id="presence"><div class="muted">Carregando‚Ä¶</div></div>
      </div>

      <div class="card">
        <h2>üéÇ Anivers√°rio mais pr√≥ximo do evento</h2>
        <div id="anniversary"><div class="muted">Carregando‚Ä¶</div></div>
      </div>

      <div class="card" style="grid-column:1 / -1">
        <h2>üèÖ Top 5 mais tempo de casado</h2>
        <div class="list" id="top5"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div>Abra com: <span class="badge">stats.html?event=SLUG_DO_EVENTO</span> ‚Ä¢ Opcional: <span class="badge">&present=1</span></div>
    <div>Fonte: Supabase ‚Ä¢ view <span class="badge">registrations_checkin</span></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.95.3/+esm";

    const SUPABASE_URL = "https://nuqcefxwarrjehvhdoug.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51cWNlZnh3YXJyamVodmhkb3VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NzE1NzUsImV4cCI6MjA4NjM0NzU3NX0.xLugRmdl6UKVsMZnDepBlFndh4vGVMnptuloFZC28Mc";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
    });

    const params = new URLSearchParams(location.search);
    const EVENT_SLUG = params.get("event")?.trim();
    let EVENT_ID = null;
    const ONLY_PRESENT = params.get("present") === "1";

    const statusEl = document.getElementById("status");
    const eventTitleEl = document.getElementById("eventTitle");
    const chipCounts = document.getElementById("chipCounts");
    const chipMode = document.getElementById("chipMode");
    const lastUpdated = document.getElementById("lastUpdated");

    const top1El = document.getElementById("top1");
    const youngestEl = document.getElementById("youngest");
    const avgEl = document.getElementById("avg");
    const presenceEl = document.getElementById("presence");
    const anniversaryEl = document.getElementById("anniversary");
    const top5El = document.getElementById("top5");

    const chartEl = document.getElementById("chart");
    let chart = null;

    chipMode.textContent = ONLY_PRESENT ? "Modo: Presentes" : "Modo: Inscritos";

    function escapeHtml(s){
      return (s ?? "").toString().replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[c]));
    }
    function formatTimeNow() {
      const now = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      const minutes = now.getMinutes();
      return minutes === 0 ? `${pad(now.getHours())}h` : `${pad(now.getHours())}h${pad(minutes)}`;
    }

    function parseISODate(iso) {
      if (!iso) return null;
      const value = String(iso).trim();
      const onlyDate = value.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (onlyDate) {
        const y = Number(onlyDate[1]);
        const m = Number(onlyDate[2]);
        const d = Number(onlyDate[3]);
        return new Date(y, m - 1, d);
      }
      const dt = new Date(value);
      return Number.isNaN(dt.getTime()) ? null : new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
    }

    function formatDateISO(dateObj) {
      if (!(dateObj instanceof Date) || Number.isNaN(dateObj.getTime())) return "‚Äî";
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, "0");
      const d = String(dateObj.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function diffYMD(fromDate, toDate) {
      let start = new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate());
      let end = new Date(toDate.getFullYear(), toDate.getMonth(), toDate.getDate());
      if (end < start) [start, end] = [end, start];

      let years = end.getFullYear() - start.getFullYear();
      let months = end.getMonth() - start.getMonth();
      let days = end.getDate() - start.getDate();

      if (days < 0) {
        const prevMonthLastDay = new Date(end.getFullYear(), end.getMonth(), 0).getDate();
        days += prevMonthLastDay;
        months -= 1;
      }
      if (months < 0) {
        months += 12;
        years -= 1;
      }
      return { years, months, days };
    }
    function score(ymd){ return ymd.years * 10000 + ymd.months * 100 + ymd.days; }
    function fmtYMD(ymd){ return `${ymd.years}a ${ymd.months}m ${ymd.days}d`; }

    function ymdToDays(ymd){ return ymd.years * 365 + ymd.months * 30 + ymd.days; }
    function daysToYMD(days){
      const years = Math.floor(days / 365);
      days -= years * 365;
      const months = Math.floor(days / 30);
      days -= months * 30;
      return { years, months, days };
    }

    function buildDistribution(rows){
      const labels = ["0‚Äì4", "5‚Äì9", "10‚Äì14", "15‚Äì19", "20‚Äì24", "25‚Äì29", "30+"];
      const counts = new Array(labels.length).fill(0);

      for (const r of rows){
        const y = r.ymd.years;
        let idx = 0;
        if (y <= 4) idx = 0;
        else if (y <= 9) idx = 1;
        else if (y <= 14) idx = 2;
        else if (y <= 19) idx = 3;
        else if (y <= 24) idx = 4;
        else if (y <= 29) idx = 5;
        else idx = 6;
        counts[idx] += 1;
      }
      return { labels, counts };
    }

    function renderChart(rows){
      const { labels, counts } = buildDistribution(rows);
      if (chart) chart.destroy();

      chart = new Chart(chartEl, {
        type: "bar",
        data: { labels, datasets: [{ label: "Casais", data: counts }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: "rgba(234,240,255,.85)" }, grid: { color: "rgba(255,255,255,.06)" } },
            y: { beginAtZero: true, ticks: { precision: 0, color: "rgba(234,240,255,.85)" }, grid: { color: "rgba(255,255,255,.06)" } }
          }
        }
      });
    }

    function renderTop1(best){
      top1El.innerHTML = `
        <div class="value">
          <div class="big">${escapeHtml(best.couple_name)}</div>
          <span class="badge">${best.wedding_date}</span>
          <span class="badge">${best.is_present ? "‚úÖ Presente" : "‚¨ú Ausente"}</span>
        </div>
        <div class="muted" style="margin-top:8px">
          <span style="color:var(--accent);font-weight:900">${fmtYMD(best.ymd)}</span> de casamento
        </div>
      `;
    }

    function renderYoungest(y){
      youngestEl.innerHTML = `
        <div class="value">
          <div class="big">${escapeHtml(y.couple_name)}</div>
          <span class="badge">${y.wedding_date}</span>
          <span class="badge">${y.is_present ? "‚úÖ Presente" : "‚¨ú Ausente"}</span>
        </div>
        <div class="muted" style="margin-top:8px">
          <span style="color:var(--warn);font-weight:900">${fmtYMD(y.ymd)}</span> de casamento
        </div>
      `;
    }

    function renderAvg(avgYmd){
      avgEl.innerHTML = `
        <div class="value">
          <div class="big">${avgYmd.years}<span style="color:var(--muted);font-weight:700"> anos</span></div>
          <span class="badge">${avgYmd.months} meses</span>
          <span class="badge">${avgYmd.days} dias</span>
        </div>
        <div class="muted" style="margin-top:8px">M√©dia aproximada (dias‚ÜíY/M/D).</div>
      `;
    }

    function renderPresence(total, present){
      const pct = total ? Math.round((present/total)*100) : 0;
      presenceEl.innerHTML = `
        <div class="value">
          <div class="big">${pct}<span style="color:var(--muted);font-weight:700">%</span></div>
          <span class="badge">${present} presentes</span>
          <span class="badge">${total-present} ausentes</span>
        </div>
        <div class="barWrap"><div class="bar" id="bar"></div></div>
        <div class="muted" style="margin-top:8px">${present} de ${total} casais.</div>
      `;
      requestAnimationFrame(() => {
        const bar = document.getElementById("bar");
        if (bar) bar.style.width = `${pct}%`;
      });
    }

    function renderTop5(list){
      top5El.innerHTML = list.map((r, i) => `
        <div class="row">
          <div class="name">
            <div class="rank">${i+1}</div>
            <span title="${escapeHtml(r.couple_name)}">${escapeHtml(r.couple_name)}</span>
          </div>
          <div class="time">${fmtYMD(r.ymd)}</div>
        </div>
      `).join("");
    }

    function closestAnniversary(rows, eventDateISO){
      if (!eventDateISO) return null;

      const eventDate = parseISODate(eventDateISO);
      if (!eventDate) return null;
      const eventYear = eventDate.getFullYear();

      let best = null;

      for (const r of rows){
        if (!r.wedding_date) continue;
        const weddingDate = parseISODate(r.wedding_date);
        if (!weddingDate) continue;

        const wy = weddingDate.getFullYear();
        const wm = weddingDate.getMonth() + 1;
        const wd = weddingDate.getDate();

        const annThisYear = new Date(eventYear, wm - 1, wd);
        if (Number.isNaN(annThisYear.getTime())) continue;
        const diffDaysSigned = Math.round((annThisYear - eventDate) / (1000*60*60*24));
        const diffAbs = Math.abs(diffDaysSigned);

        const yearsCompleting = eventYear - wy;

        if (!best || diffAbs < best.diffAbs){
          best = {
            ...r,
            anniversaryDate: annThisYear,
            diffDaysSigned,
            diffAbs,
            yearsCompleting
          };
        }
      }

      return best;
    }

    function renderAnniversary(best, eventDateISO){
      if (!best){
        anniversaryEl.innerHTML = `<div class="muted">Sem data do evento ou sem casamentos v√°lidos.</div>`;
        return;
      }

      const d = best.diffDaysSigned;
      let label = "";
      if (d === 0) label = `üéâ √â hoje!`;
      else if (d > 0) label = `Faltam <b style="color:var(--accent)">${d} dias</b>`;
      else label = `Foi h√° <b style="color:var(--warn)">${Math.abs(d)} dias</b>`;

      anniversaryEl.innerHTML = `
        <div class="value">
          <div class="big">${escapeHtml(best.couple_name)}</div>
          <span class="badge">${best.wedding_date}</span>
        </div>
        <div class="muted" style="margin-top:8px">
          <span class="badge">Data do evento: ${escapeHtml(eventDateISO)}</span>
          <span class="badge">Anivers√°rio (ano do evento): ${formatDateISO(best.anniversaryDate)}</span>
        </div>
        <div class="muted" style="margin-top:10px;line-height:1.5">
          ${label} para completar
          <b style="color:var(--good)">${best.yearsCompleting} anos</b>.
        </div>
      `;
    }


    async function resolveEventIdBySlug(){
      if (!EVENT_SLUG) return;

      const { data, error } = await supabase
        .from("events")
        .select("id")
        .eq("slug", EVENT_SLUG)
        .maybeSingle();

      if (error || !data?.id) {
        statusEl.textContent = "Erro: evento n√£o encontrado para o slug informado";
        chipCounts.className = "err";
        chipCounts.textContent = "Link inv√°lido";
        throw new Error("Invalid event slug");
      }

      EVENT_ID = data.id;
    }

    async function load(){
      if (!EVENT_ID){
        statusEl.textContent = "Erro: faltou ?event=slug";
        chipCounts.className = "err";
        chipCounts.textContent = "Link inv√°lido";
        return;
      }

      statusEl.textContent = "Atualizando‚Ä¶";

      const [regsRes, eventRes] = await Promise.all([
        supabase
          .from("registrations_checkin")
          .select("id,event_id,couple_name,wedding_date,is_present,checked_in_at,created_at")
          .eq("event_id", EVENT_ID),
        supabase
          .from("events")
          .select("id,title,event_at")
          .eq("id", EVENT_ID)
          .maybeSingle()
      ]);

      if (regsRes.error){
        statusEl.textContent = "Erro ao carregar";
        chipCounts.className = "err";
        chipCounts.textContent = "Verifique view/RLS";
        return;
      }

      const data = regsRes.data ?? [];
      const eventName = eventRes.data?.title?.trim() || "Evento";
      const eventDateISO = eventRes.data?.event_at ?? null;

      eventTitleEl.textContent = `Painel ${eventName}`;
      document.title = `Painel ‚Äî ${eventName}`;

      let rows = data.filter(r => r.wedding_date);
      if (ONLY_PRESENT) rows = rows.filter(r => r.is_present === true);

      const today = new Date();
      rows = rows.map(r => {
        const wd = parseISODate(r.wedding_date);
        if (!wd) return null;
        const ymd = diffYMD(wd, today);
        return { ...r, ymd, _score: score(ymd) };
      }).filter(Boolean);

      const totalAll = data.length;
      const presentAll = data.filter(r => r.is_present === true).length;

      chipCounts.textContent = `Inscritos: ${totalAll} ‚Ä¢ Presentes: ${presentAll}`;
      lastUpdated.textContent = `Atualizado: ${formatTimeNow()}`;

      renderPresence(totalAll, presentAll);

      // Anivers√°rio: usa TODOS (ou filtro presentes, se present=1)
      const ann = closestAnniversary(rows, eventDateISO);
      renderAnniversary(ann, eventDateISO ?? "‚Äî");

      if (rows.length === 0){
        statusEl.textContent = "Sem dados no filtro";
        top1El.innerHTML = `<div class="muted">Nenhum casal com data de casamento (ou filtro vazio).</div>`;
        youngestEl.innerHTML = `<div class="muted">‚Äî</div>`;
        avgEl.innerHTML = `<div class="muted">‚Äî</div>`;
        renderTop5([]);
        renderChart([]);
        return;
      }

      rows.sort((a,b) => b._score - a._score);

      renderTop1(rows[0]);
      renderYoungest(rows[rows.length - 1]);

      const avgDays = Math.round(rows.reduce((s,r) => s + ymdToDays(r.ymd), 0) / rows.length);
      renderAvg(daysToYMD(avgDays));

      renderTop5(rows.slice(0,5));
      renderChart(rows);

      statusEl.textContent = "Online";
    }

    await resolveEventIdBySlug();
    await load();
    setInterval(load, 30000);
  </script>
</body>
</html>
