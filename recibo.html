<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Recibo de Inscri√ß√£o ‚Äî Jantar de Casais</title>

  <style>
    :root{
      --bg:#0b1220;
      --bg2:#0a1a2f;
      --text:#eaf0ff;
      --muted:#9db0d1;
      --line:rgba(255,255,255,.10);
      --accent:#2dd4bf;
      --accent2:#60a5fa;
      --good:#2cff9a;
      --shadow: 0 14px 36px rgba(0,0,0,.45);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(45,212,191,.14), transparent 55%),
        radial-gradient(1100px 740px at 85% 15%, rgba(96,165,250,.14), transparent 55%),
        radial-gradient(900px 650px at 50% 95%, rgba(167,139,250,.10), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .wrap{width:100%; max-width:760px}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom:12px; flex-wrap:wrap;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .brand img{width:46px;height:46px; object-fit:contain}
    .brand h1{margin:0; font-size:18px; font-weight:900}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--muted); font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--accent)}
    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* √Årea que vira PNG */
    .receipt{
      padding:18px;
      background:
        radial-gradient(700px 260px at 20% 0%, rgba(45,212,191,.18), transparent 60%),
        radial-gradient(700px 260px at 80% 0%, rgba(96,165,250,.16), transparent 60%),
        rgba(0,0,0,.18);
    }

    .headline{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom:14px;
    }
    .headline .title{
      display:flex; flex-direction:column; gap:6px;
      min-width:260px;
    }
    .headline .title .big{
      margin:0;
      font-size:22px;
      font-weight:1000;
      letter-spacing:.2px;
      line-height:1.15;
    }
    .headline .title .sub{
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }

    .stamp{
      display:flex; flex-direction:column; align-items:flex-end; gap:6px;
      min-width:180px;
    }
    .stamp .ok{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(44,255,154,.30);
      background: rgba(44,255,154,.10);
      color: #caffea;
      font-weight:900;
      font-size:12px;
    }
    .stamp .id{
      color:var(--muted);
      font-size:12px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      background: rgba(255,255,255,.03);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:680px){ .grid{grid-template-columns:1fr} }

    .box{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding:12px;
    }
    .k{color:var(--muted); font-size:12px; font-weight:700; letter-spacing:.2px}
    .v{margin-top:6px; font-weight:900; font-size:14px; line-height:1.25}
    .v.small{font-size:13px; font-weight:800; color:rgba(234,240,255,.9)}

    .note{
      margin-top:12px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:16px;
      padding:12px;
      color:rgba(234,240,255,.92);
      background: rgba(0,0,0,.14);
      font-size:12.5px;
      line-height:1.45;
    }

    .actions{
      padding:12px;
      display:flex;
      justify-content:flex-end;
      flex-wrap:wrap;
      gap:10px;
      border-top:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.20);
    }
    .btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      font-size:13px;
    }
    .btnPrimary{
      border-color: rgba(45,212,191,.35);
      background: linear-gradient(90deg, rgba(45,212,191,.22), rgba(96,165,250,.18));
    }
    .err{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,93,122,.25);
      background: rgba(255,93,122,.10);
      color:#ffb2c1;
      font-weight:900;
      display:none;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <img src="logo-modern-noglow.png" alt="Casais 2 em 1" />
        <div>
          <h1>Recibo de Inscri√ß√£o</h1>
          <div class="pill"><span class="dot"></span><span id="status">Carregando‚Ä¶</span></div>
        </div>
      </div>
      <a class="pill" href="home.html" style="text-decoration:none;color:var(--muted)">Voltar para a Central</a>
    </div>

    <div class="card">
      <!-- ESTA DIV √â A QUE VIRAR√Å IMAGEM -->
      <div id="receiptShot" class="receipt">
        <div class="headline">
          <div class="title">
            <div class="big" id="evTitle">‚Äî</div>
            <div class="sub" id="evDate">‚Äî</div>
          </div>
          <div class="stamp">
            <div class="ok">‚úÖ CONFIRMADO</div>
            <div class="id">ID: <span id="rid">‚Äî</span></div>
          </div>
        </div>

        <div class="grid">
          <div class="box">
            <div class="k">Casal</div>
            <div class="v" id="couple">‚Äî</div>
          </div>
          <div class="box">
            <div class="k">Telefone</div>
            <div class="v" id="phone">‚Äî</div>
          </div>
          <div class="box">
            <div class="k">Data de casamento</div>
            <div class="v" id="wedding">‚Äî</div>
          </div>
          <div class="box">
            <div class="k">Prato escolhido</div>
            <div class="v" id="dish">‚Äî</div>
            <div class="v small" id="dishHint">‚Äî</div>
          </div>
        </div>

        <div class="note" id="note">
          Guarde este recibo. Caso necess√°rio, apresente este comprovante no check-in.
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnCopy">Copiar link</button>
        <button class="btn" id="btnPng">Salvar como imagem</button>
        <button class="btn btnPrimary" id="btnShare">Compartilhar</button>
      </div>
    </div>

    <div id="err" class="err"></div>
  </div>

  <!-- biblioteca para salvar como imagem -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.95.3/+esm";

    const SUPABASE_URL = "https://nuqcefxwarrjehvhdoug.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51cWNlZnh3YXJyamVodmhkb3VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NzE1NzUsImV4cCI6MjA4NjM0NzU3NX0.xLugRmdl6UKVsMZnDepBlFndh4vGVMnptuloFZC28Mc";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession:false, autoRefreshToken:false, detectSessionInUrl:false }
    });

    const params = new URLSearchParams(location.search);
    const rid = params.get("rid");

    const statusEl = document.getElementById("status");
    const errEl = document.getElementById("err");

    const evTitle = document.getElementById("evTitle");
    const evDate  = document.getElementById("evDate");
    const couple  = document.getElementById("couple");
    const phone   = document.getElementById("phone");
    const wedding = document.getElementById("wedding");
    const dish    = document.getElementById("dish");
    const dishHint= document.getElementById("dishHint");
    const ridEl   = document.getElementById("rid");

    const btnCopy = document.getElementById("btnCopy");
    const btnPng  = document.getElementById("btnPng");
    const btnShare= document.getElementById("btnShare");

    function showErr(msg){
      errEl.textContent = msg;
      errEl.style.display = "block";
      statusEl.textContent = "Erro";
    }

    function formatDateTime(value){
      if (!value) return "‚Äî";
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return "‚Äî";
      return new Intl.DateTimeFormat("pt-BR", {
        day:"2-digit", month:"2-digit", year:"numeric",
        hour:"2-digit", minute:"2-digit"
      }).format(d);
    }

    function selfLink(){
      return window.location.href;
    }

    btnCopy.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(selfLink());
        statusEl.textContent = "Link copiado ‚úÖ";
        setTimeout(()=> statusEl.textContent = "Pronto", 1200);
      }catch{
        showErr("N√£o foi poss√≠vel copiar automaticamente. Copie pela barra de endere√ßo.");
      }
    });

    async function exportPngBlob(){
      const node = document.getElementById("receiptShot");
      const canvas = await html2canvas(node, {
        backgroundColor: null,
        scale: Math.min(window.devicePixelRatio || 2, 2) // bom e leve
      });
      return new Promise(resolve => canvas.toBlob(resolve, "image/png", 1));
    }

    btnPng.addEventListener("click", async () => {
      try{
        statusEl.textContent = "Gerando imagem‚Ä¶";
        const blob = await exportPngBlob();
        if (!blob) throw new Error("blob");
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `recibo-${rid || "inscricao"}.png`;
        a.click();
        URL.revokeObjectURL(url);
        statusEl.textContent = "Imagem salva ‚úÖ";
        setTimeout(()=> statusEl.textContent = "Pronto", 1200);
      }catch{
        showErr("N√£o foi poss√≠vel salvar a imagem neste dispositivo/navegador.");
      }
    });

    btnShare.addEventListener("click", async () => {
      try{
        const link = selfLink();
        const text =
          `Recibo da inscri√ß√£o ‚Äî ${evTitle.textContent}\n` +
          `${evDate.textContent}\n` +
          `Casal: ${couple.textContent}\n` +
          `Link: ${link}`;

        // tenta compartilhar imagem (melhor), se suportado
        if (navigator.canShare && navigator.share){
          statusEl.textContent = "Preparando‚Ä¶";
          const blob = await exportPngBlob();
          const file = new File([blob], `recibo-${rid || "inscricao"}.png`, { type: "image/png" });

          if (navigator.canShare({ files: [file] })){
            await navigator.share({ title: "Recibo de Inscri√ß√£o", text, files: [file] });
            statusEl.textContent = "Compartilhado ‚úÖ";
            setTimeout(()=> statusEl.textContent = "Pronto", 1200);
            return;
          }
        }

        // fallback: compartilhar link
        if (navigator.share){
          await navigator.share({ title:"Recibo de Inscri√ß√£o", text, url: link });
          statusEl.textContent = "Compartilhado ‚úÖ";
          setTimeout(()=> statusEl.textContent = "Pronto", 1200);
          return;
        }

        // fallback: copiar link
        await navigator.clipboard.writeText(link);
        statusEl.textContent = "Link copiado ‚úÖ";
        setTimeout(()=> statusEl.textContent = "Pronto", 1200);
      }catch{
        // cancelado pelo usu√°rio -> ok
        statusEl.textContent = "Pronto";
      }
    });

    async function load(){
      if (!rid){
        showErr("Link inv√°lido: faltou ?rid=...");
        return;
      }

      // Inscri√ß√£o
      const { data: reg, error: regErr } = await supabase
        .from("registrations")
        .select("id,event_id,couple_name,wedding_date,phone,dish_id,created_at")
        .eq("id", rid)
        .maybeSingle();

      if (regErr || !reg){
        showErr("N√£o foi poss√≠vel encontrar esta inscri√ß√£o.");
        return;
      }

      const [evRes, dishRes] = await Promise.all([
        supabase.from("events").select("title,event_date").eq("id", reg.event_id).maybeSingle(),
        reg.dish_id ? supabase.from("dishes").select("name").eq("id", reg.dish_id).maybeSingle() : Promise.resolve({ data:null })
      ]);

      evTitle.textContent = evRes.data?.title ?? "Evento";
      evDate.textContent = formatDateTime(evRes.data?.event_date);
      couple.textContent = reg.couple_name ?? "‚Äî";
      phone.textContent = reg.phone ?? "‚Äî";
      wedding.textContent = reg.wedding_date ?? "‚Äî";
      dish.textContent = dishRes.data?.name ?? (reg.dish_id ? "Prato selecionado" : "‚Äî");
      dishHint.textContent = reg.dish_id ? "Obrigado por contribuir com o jantar üíú" : "‚Äî";
      ridEl.textContent = reg.id;

      statusEl.textContent = "Pronto";
    }

    await load();
  </script>
</body>
</html>
