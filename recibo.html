<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Recibo de Inscrição — Casais 2 em 1</title>

<style>
:root{
  --bg:#0b1220;
  --bg2:#0a1a2f;
  --text:#ffffff;
  --muted:#cbd5e1;
  --line:rgba(255,255,255,.12);
  --accent:#2dd4bf;
  --shadow:0 30px 80px rgba(0,0,0,.55);
  --radius:22px;
}
*{box-sizing:border-box}

body{
  margin:0;
  font-family:"Inter",system-ui;
  color:var(--text);
  background:
    radial-gradient(1000px 600px at 20% 0%, rgba(45,212,191,.18), transparent 60%),
    radial-gradient(1000px 600px at 80% 0%, rgba(96,165,250,.16), transparent 60%),
    linear-gradient(180deg,var(--bg),var(--bg2));
  min-height:100dvh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:16px;
}

.wrap{width:100%;max-width:900px;position:relative}

.home-link {
  position: absolute;
  top: 10px;
  right: 10px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 42px;
  height: 42px;
  color: #bfdbfe;
  text-decoration: none;
  border-radius: 999px;
  border: 1px solid rgba(191, 219, 254, 0.45);
  background: rgba(15, 23, 42, 0.25);
  z-index: 2;
}

.home-link:hover,
.home-link:focus-visible {
  color: #dbeafe;
  border-color: rgba(219, 234, 254, 0.85);
  background: rgba(15, 23, 42, 0.4);
}

.home-link svg {
  width: 20px;
  height: 20px;
}

.card{
  border-radius:var(--radius);
  border:1px solid var(--line);
  box-shadow:var(--shadow);
  overflow:hidden;
  background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));
}

/* ÁREA QUE VIRA IMAGEM */
.receipt{
  padding:26px;
  display:grid;
  grid-template-columns: 1.3fr .7fr;
  gap:20px;
}

@media(max-width:780px){
  body{padding:8px}
  .receipt{
    grid-template-columns:1fr;
    padding:14px;
    gap:12px;
  }
}

.left{
  display:flex;
  flex-direction:column;
  gap:18px;
}

.eventHeader{
  display:flex;
  align-items:center;
  gap:12px;
}

.eventLogo{
  width:60px;
  height:60px;
  object-fit:contain;
  flex-shrink:0;
}

.eventTitle{
  font-size:26px;
  font-weight:1000;
  line-height:1.1;
}

.eventDate{
  color:var(--muted);
  font-size:15px;
}

.section{
  border:1px solid var(--line);
  border-radius:18px;
  padding:16px;
  background:rgba(0,0,0,.20);
}

.label{
  font-size:12px;
  color:var(--muted);
  font-weight:800;
  letter-spacing:.3px;
}

.value{
  margin-top:6px;
  font-size:20px;
  font-weight:1000;
  line-height:1.25;
}

.value.big{
  font-size:24px;
}

.right{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:16px;
  border-left:1px dashed rgba(255,255,255,.15);
  padding-left:20px;
}

@media(max-width:780px){
  .right{
    border-left:none;
    border-top:1px dashed rgba(255,255,255,.15);
    padding-left:0;
    padding-top:12px;
    gap:10px;
  }
}

@media(max-width:780px){
  .left{gap:12px}
  .eventLogo{width:46px;height:46px}
  .eventTitle{font-size:20px}
  .eventDate{font-size:13px}
  .section{padding:10px;border-radius:14px}
  .value{font-size:16px;line-height:1.2}
  .value.big{font-size:clamp(16px,4.2vw,18px)}
  .confirm{font-size:12px;padding:8px 12px}
  .qrBox{width:140px;height:140px;padding:10px;border-radius:14px}
  .qrBox img{width:120px;height:120px}
  .qrLabel{font-size:11px}
  .actions{padding:10px}
  .btn{padding:10px 14px;font-size:13px}
}

.qrBox{
  width:200px;
  height:200px;
  background:#fff;
  border-radius:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}

.qrBox img{
  width:170px;
  height:170px;
}

.qrLabel{
  font-size:13px;
  font-weight:800;
  text-align:center;
  color:#e2e8f0;
}

.confirm{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 16px;
  border-radius:999px;
  border:1px solid rgba(44,255,154,.40);
  background:rgba(44,255,154,.12);
  font-weight:900;
  font-size:13px;
}

.actions{
  padding:16px;
  display:flex;
  justify-content:center;
  border-top:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.25);
}

.btn{
  padding:12px 18px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.18);
  background:linear-gradient(90deg,rgba(45,212,191,.28),rgba(96,165,250,.22));
  font-weight:900;
  cursor:pointer;
  font-size:14px;
}
</style>
</head>

<body>
<div class="wrap">
<a class="home-link" id="newRegistrationLink" href="index.html" aria-label="Nova inscrição" title="Nova inscrição">
  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M12 5v14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
    <path d="M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
  </svg>
</a>
<div class="card">

<div id="receiptShot" class="receipt">

<div class="left">
  <div class="eventHeader">
    <img class="eventLogo" src="./logo-modern-noglow.png" alt="Logo Casais 2 em 1"/>
    <div>
      <div class="eventTitle" id="evTitle">—</div>
      <div class="eventDate" id="evDate">—</div>
    </div>
  </div>

  <div class="confirm">✅ INSCRIÇÃO CONFIRMADA</div>

  <div class="section">
    <div class="label">CASAL</div>
    <div class="value big" id="couple">—</div>
  </div>

  <div class="section">
    <div class="label">TELEFONE</div>
    <div class="value" id="phone">—</div>
  </div>

  <div class="section">
    <div class="label">DATA DE CASAMENTO</div>
    <div class="value" id="wedding">—</div>
  </div>

  <div class="section">
    <div class="label">PRATO</div>
    <div class="value" id="dish">—</div>
  </div>
</div>

<div class="right">
  <div class="qrBox" id="qrBox"></div>
  <div class="qrLabel">Apresente este QR no check-in</div>
</div>

</div>

<div class="actions">
  <button class="btn" id="btnShare">Compartilhar recibo</button>
</div>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.95.3/+esm";

const SUPABASE_URL = "https://nuqcefxwarrjehvhdoug.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51cWNlZnh3YXJyamVodmhkb3VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NzE1NzUsImV4cCI6MjA4NjM0NzU3NX0.xLugRmdl6UKVsMZnDepBlFndh4vGVMnptuloFZC28Mc";


const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY,{
  auth:{persistSession:false,autoRefreshToken:false,detectSessionInUrl:false}
});

const params=new URLSearchParams(location.search);
const rid=params.get("rid");

const evTitle=document.getElementById("evTitle");
const evDate=document.getElementById("evDate");
const couple=document.getElementById("couple");
const phone=document.getElementById("phone");
const wedding=document.getElementById("wedding");
const dish=document.getElementById("dish");
const qrBox=document.getElementById("qrBox");
const btnShare=document.getElementById("btnShare");

function formatDateTime(v){
  if(!v)return "—";
  const d=new Date(v);
  return new Intl.DateTimeFormat("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}).format(d);
}

function formatDate(v){
  if(!v)return "—";
  const d = new Date(`${v}T00:00:00`);
  if(Number.isNaN(d.getTime())) return "—";
  return new Intl.DateTimeFormat("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric"}).format(d);
}

async function generateQR(id){
  const payload=`rid:${id}`;
  const qrUrl=`https://api.qrserver.com/v1/create-qr-code/?size=170x170&margin=1&data=${encodeURIComponent(payload)}`;
  const qrResponse=await fetch(qrUrl);
  if(!qrResponse.ok){
    throw new Error("Não foi possível gerar o QR Code.");
  }

  const qrBlob=await qrResponse.blob();
  const qrDataUrl=await new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=()=>resolve(reader.result);
    reader.onerror=reject;
    reader.readAsDataURL(qrBlob);
  });

  const img=document.createElement("img");
  img.alt="QR Code do recibo";
  img.src=String(qrDataUrl);

  await img.decode();

  qrBox.innerHTML="";
  qrBox.appendChild(img);
}

async function load(){
  if(!rid)return;

  const {data:reg}=await supabase
    .from("registrations")
    .select("id,event_id,couple_name,wedding_date,phone,dish_id")
    .eq("id",rid)
    .maybeSingle();

  if(!reg)return;

  const {data:ev}=await supabase
    .from("events")
    .select("title,event_date")
    .eq("id",reg.event_id)
    .maybeSingle();

  const {data:dishRes}=reg.dish_id
    ? await supabase.from("dishes").select("name").eq("id",reg.dish_id).maybeSingle()
    : {data:null};

  evTitle.textContent=ev?.title??"Evento";
  evDate.textContent=formatDateTime(ev?.event_date);
  couple.textContent=reg.couple_name??"—";
  phone.textContent=reg.phone??"—";
  wedding.textContent=formatDate(reg.wedding_date);
  dish.textContent=dishRes?.name??"—";

  await generateQR(reg.id);
}

async function exportImage(){
  if(typeof html2canvas!=="function"){
    throw new Error("Biblioteca de captura indisponível.");
  }
  const canvas=await html2canvas(document.getElementById("receiptShot"),{
    backgroundColor:null,
    scale:2,
    useCORS:true
  });
  return new Promise(resolve=>canvas.toBlob(resolve,"image/png"));
}

btnShare.addEventListener("click",async()=>{
  try{
    const blob=await exportImage();
    if(!blob) throw new Error("Falha ao gerar imagem.");

    const file=new File([blob],"recibo.png",{type:"image/png"});
    if(navigator.canShare&&navigator.canShare({files:[file]})){
      await navigator.share({files:[file],title:"Recibo de inscrição"});
      return;
    }

    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="recibo.png";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }catch(err){
    console.error(err);
    alert("Não foi possível compartilhar agora. Tente novamente.");
  }
});

await load();
</script>
</body>
</html>
