<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Recibo de Inscrição — Casais 2 em 1</title>

<style>
:root{
  --bg:#0b1220;
  --bg2:#0a1a2f;
  --text:#ffffff;
  --muted:#cbd5e1;
  --line:rgba(255,255,255,.12);
  --accent:#2dd4bf;
  --shadow:0 30px 80px rgba(0,0,0,.55);
  --radius:22px;
}
*{box-sizing:border-box}

body{
  margin:0;
  font-family:"Inter",system-ui;
  color:var(--text);
  background:
    radial-gradient(1000px 600px at 20% 0%, rgba(45,212,191,.18), transparent 60%),
    radial-gradient(1000px 600px at 80% 0%, rgba(96,165,250,.16), transparent 60%),
    linear-gradient(180deg,var(--bg),var(--bg2));
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
}

.wrap{width:100%;max-width:900px}

.card{
  border-radius:var(--radius);
  border:1px solid var(--line);
  box-shadow:var(--shadow);
  overflow:hidden;
  background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));
}

/* ÁREA QUE VIRA IMAGEM */
.receipt{
  padding:26px;
  display:grid;
  grid-template-columns: 1.3fr .7fr;
  gap:20px;
}

@media(max-width:780px){
  .receipt{grid-template-columns:1fr}
}

.left{
  display:flex;
  flex-direction:column;
  gap:18px;
}

.eventTitle{
  font-size:26px;
  font-weight:1000;
  line-height:1.1;
}

.eventDate{
  color:var(--muted);
  font-size:15px;
}

.section{
  border:1px solid var(--line);
  border-radius:18px;
  padding:16px;
  background:rgba(0,0,0,.20);
}

.label{
  font-size:12px;
  color:var(--muted);
  font-weight:800;
  letter-spacing:.3px;
}

.value{
  margin-top:6px;
  font-size:20px;
  font-weight:1000;
  line-height:1.25;
}

.value.big{
  font-size:24px;
}

.right{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:16px;
  border-left:1px dashed rgba(255,255,255,.15);
  padding-left:20px;
}

@media(max-width:780px){
  .right{
    border-left:none;
    border-top:1px dashed rgba(255,255,255,.15);
    padding-left:0;
    padding-top:20px;
  }
}

.qrBox{
  width:200px;
  height:200px;
  background:#fff;
  border-radius:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}

.qrBox img{
  width:170px;
  height:170px;
}

.qrLabel{
  font-size:13px;
  font-weight:800;
  text-align:center;
  color:#e2e8f0;
}

.confirm{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 16px;
  border-radius:999px;
  border:1px solid rgba(44,255,154,.40);
  background:rgba(44,255,154,.12);
  font-weight:900;
  font-size:13px;
}

.actions{
  padding:16px;
  display:flex;
  justify-content:center;
  border-top:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.25);
}

.btn{
  padding:12px 18px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.18);
  background:linear-gradient(90deg,rgba(45,212,191,.28),rgba(96,165,250,.22));
  font-weight:900;
  cursor:pointer;
  font-size:14px;
}
</style>
</head>

<body>
<div class="wrap">
<div class="card">

<div id="receiptShot" class="receipt">

<div class="left">
  <div>
    <div class="eventTitle" id="evTitle">—</div>
    <div class="eventDate" id="evDate">—</div>
  </div>

  <div class="confirm">✅ INSCRIÇÃO CONFIRMADA</div>

  <div class="section">
    <div class="label">CASAL</div>
    <div class="value big" id="couple">—</div>
  </div>

  <div class="section">
    <div class="label">TELEFONE</div>
    <div class="value" id="phone">—</div>
  </div>

  <div class="section">
    <div class="label">DATA DE CASAMENTO</div>
    <div class="value" id="wedding">—</div>
  </div>

  <div class="section">
    <div class="label">PRATO</div>
    <div class="value" id="dish">—</div>
  </div>
</div>

<div class="right">
  <div class="qrBox" id="qrBox"></div>
  <div class="qrLabel">Apresente este QR no check-in</div>
</div>

</div>

<div class="actions">
  <button class="btn" id="btnShare">Compartilhar recibo</button>
</div>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.95.3/+esm";

const SUPABASE_URL = "https://nuqcefxwarrjehvhdoug.supabase.co";
const SUPABASE_ANON_KEY = "SUA_CHAVE_AQUI";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY,{
  auth:{persistSession:false,autoRefreshToken:false,detectSessionInUrl:false}
});

const params=new URLSearchParams(location.search);
const rid=params.get("rid");

const evTitle=document.getElementById("evTitle");
const evDate=document.getElementById("evDate");
const couple=document.getElementById("couple");
const phone=document.getElementById("phone");
const wedding=document.getElementById("wedding");
const dish=document.getElementById("dish");
const qrBox=document.getElementById("qrBox");
const btnShare=document.getElementById("btnShare");

function formatDateTime(v){
  if(!v)return "—";
  const d=new Date(v);
  return new Intl.DateTimeFormat("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}).format(d);
}

async function generateQR(id){
  const payload=`rid:${id}`;
  const url=await QRCode.toDataURL(payload,{width:170,margin:1});
  const img=document.createElement("img");
  img.src=url;
  qrBox.innerHTML="";
  qrBox.appendChild(img);
}

async function load(){
  if(!rid)return;

  const {data:reg}=await supabase
    .from("registrations")
    .select("id,event_id,couple_name,wedding_date,phone,dish_id")
    .eq("id",rid)
    .maybeSingle();

  if(!reg)return;

  const {data:ev}=await supabase
    .from("events")
    .select("title,event_date")
    .eq("id",reg.event_id)
    .maybeSingle();

  const {data:dishRes}=reg.dish_id
    ? await supabase.from("dishes").select("name").eq("id",reg.dish_id).maybeSingle()
    : {data:null};

  evTitle.textContent=ev?.title??"Evento";
  evDate.textContent=formatDateTime(ev?.event_date);
  couple.textContent=reg.couple_name??"—";
  phone.textContent=reg.phone??"—";
  wedding.textContent=reg.wedding_date??"—";
  dish.textContent=dishRes?.name??"—";

  await generateQR(reg.id);
}

async function exportImage(){
  const canvas=await html2canvas(document.getElementById("receiptShot"),{
    backgroundColor:null,
    scale:2
  });
  return new Promise(resolve=>canvas.toBlob(resolve,"image/png"));
}

btnShare.addEventListener("click",async()=>{
  const blob=await exportImage();
  const file=new File([blob],"recibo.png",{type:"image/png"});
  if(navigator.canShare&&navigator.canShare({files:[file]})){
    await navigator.share({files:[file]});
  }
});

await load();
</script>
</body>
</html>
