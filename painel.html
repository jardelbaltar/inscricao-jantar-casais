<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inscrições - Carregando evento...</title>
  <style>
    :root {
      --bg: #0f172a;
      --surface: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --primary: #2563eb;
      --success: #0f766e;
      --border: #e2e8f0;
      --shadow: 0 20px 45px rgba(15, 23, 42, 0.24);
      --radius: 18px;
    }

    * { box-sizing: border-box; }

    html,
    body {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }

    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top right, #1e3a8a 0%, var(--bg) 42%, #020617 100%);
      color: var(--text);
      min-height: 100vh;
      padding: max(16px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(18px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left));
    }

    .container {
      width: 100%;
      max-width: 1060px;
      margin: 0 auto;
      display: grid;
      gap: 12px;
      min-width: 0;
    }

    .hero {
      color: #f8fafc;
      text-align: center;
      padding: 4px;
    }

    .hero-top {
      display: grid;
      grid-template-columns: 52px 1fr 52px;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .brand {
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }

    .brandMark img {
      width: 52px;
      height: 52px;
      object-fit: contain;
    }


    .hero h1 {
      margin: 0;
      font-size: clamp(1.55rem, 5vw, 2.3rem);
      line-height: 1.2;
    }

    .hero p {
      margin: 8px 0 0;
      color: #cbd5e1;
      font-size: 0.98rem;
      line-height: 1.45;
    }

    .hero-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #dbeafe;
      background: rgba(15, 23, 42, 0.35);
      border: 1px solid rgba(191, 219, 254, 0.35);
      border-radius: 999px;
      padding: 7px 13px;
      text-decoration: none;
      font-weight: 700;
      transition: transform .15s ease, background-color .15s ease;
    }

    .hero-link:hover,
    .hero-link:focus-visible {
      transform: translateY(-1px);
      background: rgba(15, 23, 42, 0.55);
    }

    .hero-link-icon {
      font-size: 1rem;
      line-height: 1;
    }

    .home-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 42px;
      height: 42px;
      justify-self: end;
      color: #bfdbfe;
      text-decoration: none;
      border-radius: 999px;
      border: 1px solid rgba(191, 219, 254, 0.45);
      background: rgba(15, 23, 42, 0.25);
    }

    .home-link:hover,
    .home-link:focus-visible {
      color: #dbeafe;
      border-color: rgba(219, 234, 254, 0.85);
      background: rgba(15, 23, 42, 0.4);
    }

    .home-link svg {
      width: 20px;
      height: 20px;
    }

    .card {
      background: linear-gradient(160deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid rgba(148, 163, 184, 0.28);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      min-width: 0;
    }

    .panel {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 12px;
    }

    .big-box {
      border-radius: 14px;
      padding: 14px;
      border: 1px solid var(--border);
      background: #fff;
    }

    .big-box h2 {
      margin: 0;
      font-size: 0.95rem;
      color: var(--muted);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .03em;
    }

    .big-number {
      margin-top: 6px;
      font-size: clamp(2rem, 9vw, 3.4rem);
      font-weight: 800;
      line-height: 1;
    }

    .big-box.primary .big-number { color: var(--primary); }
    .big-box.success .big-number { color: var(--success); }

    .big-box.waiting .big-number { color: #b45309; }

    .meta {
      margin-top: 8px;
      color: var(--muted);
      font-size: .95rem;
    }

    .table-wrap {
      margin-top: 12px;
      width: 100%;
      max-width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
    }

    th, td {
      text-align: left;
      padding: 11px 10px;
      border-bottom: 1px solid #edf2f7;
      white-space: nowrap;
    }

    th {
      font-size: .85rem;
      text-transform: uppercase;
      letter-spacing: .02em;
      color: #334155;
      background: #f8fafc;
    }

    tr:last-child td { border-bottom: 0; }

    #msg {
      min-height: 22px;
      margin: 8px 0 0;
      font-weight: 700;
    }

    .err {
      color: #b91c1c;
      background: #fee2e2;
      border: 1px solid #fecaca;
      border-radius: 10px;
      padding: 8px 10px;
    }

    .muted { color: var(--muted); }

    .receipt-shortcut {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      font-size: 1rem;
      line-height: 1;
    }

    .receipt-shortcut:hover,
    .receipt-shortcut:focus-visible {
      transform: scale(1.08);
    }

    th:nth-child(1),
    td:nth-child(1),
    th:nth-child(2),
    td:nth-child(2) {
      text-align: center;
      width: 1%;
    }

    @media (max-width: 820px) {
      .panel {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      body {
        padding: 14px 10px 16px;
      }

      .card {
        padding: 14px;
        border-radius: 14px;
      }

      .panel {
        grid-template-columns: 1fr;
      }

      .big-box {
        padding: 13px;
      }

      .meta {
        font-size: 0.9rem;
        line-height: 1.45;
      }

      table {
        min-width: 600px;
      }

      th, td {
        font-size: 0.93rem;
      }

      thead {
        display: none;
      }

      table {
        min-width: 100%;
      }

      td {
        padding: 10px 8px;
      }

      td:nth-child(1),
      td:nth-child(2) {
        padding-left: 4px;
        padding-right: 4px;
      }

      td:nth-child(3) {
        padding-left: 6px;
      }
    }
  </style>
</head>
<body>
  <main class="container">
    <section class="hero">
      <div class="hero-top">
        <div class="brand">
          <div class="brandMark">
            <img src="/logo-modern-noglow.png" alt="Casais 2 em 1" />
          </div>
        </div>
        <h1 id="heroTitle">Carregando evento...</h1>
        <a class="home-link" id="newRegistrationLink" href="index.html" aria-label="Nova inscrição" title="Nova inscrição">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 5v14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </a>
      </div>
      <p id="heroSubtitle">Carregando informações do evento...</p>
    </section>

    <section class="card">
      <div class="panel">
        <article class="big-box primary">
          <h2>Confirmados</h2>
          <div class="big-number" id="totalRegistered">--</div>
        </article>
        <article class="big-box success">
          <h2>Vagas restantes</h2>
          <div class="big-number" id="remainingSlots">--</div>
        </article>
        <article class="big-box waiting">
          <h2>Lista de espera</h2>
          <div class="big-number" id="waitlistTotal">--</div>
        </article>
      </div>
      <p id="msg"></p>
    </section>

    <section class="card">
      <h2 style="margin:0">Lista completa</h2>
      <div class="table-wrap" id="tableWrap">
        <p class="muted">Carregando inscrições...</p>
      </div>
    </section>
  </main>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.95.3/+esm";

    const SUPABASE_URL = "https://nuqcefxwarrjehvhdoug.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51cWNlZnh3YXJyamVodmhkb3VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NzE1NzUsImV4cCI6MjA4NjM0NzU3NX0.xLugRmdl6UKVsMZnDepBlFndh4vGVMnptuloFZC28Mc";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: false,
        autoRefreshToken: false,
        detectSessionInUrl: false
      }
    });

    const params = new URLSearchParams(location.search);
    const eventSlug = params.get("event")?.trim();
    let eventId = null;

    const heroTitle = document.getElementById("heroTitle");
    const heroSubtitle = document.getElementById("heroSubtitle");
    const newRegistrationLink = document.getElementById("newRegistrationLink");
    const totalRegistered = document.getElementById("totalRegistered");
    const remainingSlots = document.getElementById("remainingSlots");
    const waitlistTotal = document.getElementById("waitlistTotal");
    const tableWrap = document.getElementById("tableWrap");
    const msg = document.getElementById("msg");
    const POLLING_MS = 15000;
    let isRefreshing = false;
    let pendingRefresh = false;
    let pollingId = null;
    let realtimeChannel = null;

    function setError(text) {
      msg.className = "err";
      msg.textContent = text;
    }

    function setInfo(text) {
      msg.className = "muted";
      msg.textContent = text;
    }

    function escapeHtml(s) {
      return (s ?? "").toString().replace(/[&<>"']/g, (c) => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[c]));
    }

    function formatDateTime(value) {
      if (!value) return "—";
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return "—";
      const pad = (n) => String(n).padStart(2, "0");
      const minutes = d.getMinutes();
      const timeLabel = minutes === 0
        ? `${pad(d.getHours())}h`
        : `${pad(d.getHours())}h${pad(minutes)}`;
      return `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()} ${timeLabel}`;
    }

    function formatDate(value) {
      if (!value) return "—";
      const [y, m, d] = value.split("-");
      if (!y || !m || !d) return escapeHtml(value);
      return `${d}/${m}/${y}`;
    }

    function maskPhone(phone) {
      const digits = (phone ?? "").replace(/\D/g, "");
      if (!digits) return "—";
      const last4 = digits.slice(-4);
      return `******${last4}`;
    }

    function createAppUrl(filename) {
      return new URL(`/${filename}`, window.location.origin);
    }

    function getReceiptUrl(registrationId) {
      const url = createAppUrl("recibo.html");

      url.search = "";
      url.hash = "";
      url.searchParams.set("rid", registrationId);
      return url.toString();
    }

    function getNewRegistrationUrl() {
      const url = createAppUrl("index.html");

      url.search = "";
      url.hash = "";
      url.searchParams.set("event", eventSlug);
      return url.toString();
    }

    if (!eventSlug) {
      setError("Link inválido: faltou o parâmetro ?event=.");
      document.title = "Inscrições - Evento não informado";
      heroTitle.textContent = "Evento não informado";
      heroSubtitle.textContent = "Data do evento indisponível - Limite indisponível";
      tableWrap.innerHTML = "<p class='muted'>Sem evento para consultar.</p>";
      throw new Error("Missing event");
    }

    newRegistrationLink.href = getNewRegistrationUrl();

    async function resolveEventIdBySlug() {
      const { data, error } = await supabase
        .from("events")
        .select("id")
        .eq("slug", eventSlug)
        .maybeSingle();

      if (error || !data?.id) {
        setError("Este evento não existe mais (ou o link está incorreto). Confira o parâmetro ?event=.");
        document.title = "Inscrições - Evento não encontrado";
        heroTitle.textContent = "Evento não encontrado";
        heroSubtitle.textContent = "Data do evento indisponível - Limite indisponível";
        tableWrap.innerHTML = "<p class='muted'>Nenhuma inscrição para exibir.</p>";
        throw new Error("Invalid event slug");
      }

      eventId = data.id;
    }



    async function loadPanel() {
      if (isRefreshing) {
        pendingRefresh = true;
        return;
      }

      isRefreshing = true;
      msg.textContent = "";
      msg.className = "";

      try {
        const { data: eventData, error: eventError } = await supabase
          .from("events")
          .select("id,title,event_at,max_couples")
          .eq("id", eventId)
          .maybeSingle();

        if (eventError) {
          document.title = "Inscrições - Evento não encontrado";
          heroTitle.textContent = "Evento não encontrado";
          heroSubtitle.textContent = "Data do evento indisponível - Limite indisponível";
          setError("Não foi possível carregar o evento.");
          tableWrap.innerHTML = "<p class='muted'>Nenhuma inscrição para exibir.</p>";
          return;
        }

        const { count, error: countError } = await supabase
          .from("registrations_checkin")
          .select("id", { count: "exact", head: true })
          .eq("event_id", eventId);

        if (countError) {
          setError("Erro ao carregar o total de inscritos.");
        }

        const inscritos = count ?? 0;

        if (!eventData) {
          const { count: dishCount, error: dishError } = await supabase
            .from("dishes")
            .select("id", { count: "exact", head: true })
            .eq("event_id", eventId);

          const hasAnyPublicData = inscritos > 0 || (dishCount ?? 0) > 0;
          const canConfirmEventDoesNotExist = !hasAnyPublicData && !dishError;

          if (canConfirmEventDoesNotExist) {
            document.title = "Inscrições - Evento não encontrado";
            heroTitle.textContent = "Evento não encontrado";
            heroSubtitle.textContent = "Data do evento indisponível - Limite indisponível";
            setError("Este evento não existe mais (ou o link está incorreto). Confira o parâmetro ?event=.");
            tableWrap.innerHTML = "<p class='muted'>Nenhuma inscrição para exibir.</p>";
            totalRegistered.textContent = "0";
            remainingSlots.textContent = "0";
            waitlistTotal.textContent = "0";
            return;
          }

          document.title = "Inscrições - Evento ativo";
          heroTitle.textContent = "Evento ativo";
          heroSubtitle.textContent = "Data do evento indisponível - Limite indisponível";
          totalRegistered.textContent = inscritos;
          remainingSlots.textContent = "—";
          waitlistTotal.textContent = "—";

          if (dishError && inscritos === 0) {
            setInfo("Não foi possível validar os dados públicos do evento agora. Tente novamente em instantes.");
          } else {
            setInfo("Não foi possível carregar título/data do evento, mas os inscritos continuam disponíveis.");
          }
        } else {
          const limite = Number(eventData.max_couples ?? 0);
          const hasFiniteLimit = limite > 0;
          const vagas = hasFiniteLimit ? Math.max(limite - inscritos, 0) : "∞";
          const emEspera = hasFiniteLimit ? Math.max(inscritos - limite, 0) : 0;

          document.title = `Inscrições - ${eventData.title}`;
          heroTitle.textContent = eventData.title;
          heroSubtitle.textContent = `${formatDateTime(eventData.event_at)} - ${hasFiniteLimit ? `${limite} casais` : "Sem limite de casais"}`;
          totalRegistered.textContent = inscritos;
          remainingSlots.textContent = vagas;
          waitlistTotal.textContent = emEspera;
        }

        const { data: registrations, error: regError } = await supabase
          .from("registrations_checkin")
          .select(`
            id,
            couple_name,
            queue_pos,
            created_at
          `)
          .eq("event_id", eventId)
          .order("queue_pos", { ascending: true, nullsFirst: false })
          .order("created_at", { ascending: true });

        if (regError) {
          tableWrap.innerHTML = "<p class='err'>Erro ao carregar inscrições.</p>";
          return;
        }

        const limit = Number(eventData?.max_couples ?? 0);
        const hasFiniteLimit = limit > 0;
        const rows = (registrations ?? []).map((r, idx) => {
          const queuePos = Number(r.queue_pos ?? idx + 1);
          const isConfirmed = hasFiniteLimit ? queuePos <= limit : true;
          const statusIcon = isConfirmed
            ? `<a class="receipt-shortcut" href="${escapeHtml(getReceiptUrl(r.id))}" title="Ver recibo de ${escapeHtml(r.couple_name)}" aria-label="Ver recibo de ${escapeHtml(r.couple_name)}">✅</a>`
            : "⏳";
          const statusLabel = isConfirmed ? "Confirmado" : "Lista de espera";
          return `
          <tr>
            <td title="${statusLabel}">${statusIcon}</td>
            <td>${escapeHtml(String(queuePos))}</td>
            <td><strong>${escapeHtml(r.couple_name)}</strong></td>
          </tr>
        `;
        }).join("");

        tableWrap.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Status</th>
                <th>Inscrição</th>
                <th>Nome do casal</th>
              </tr>
            </thead>
            <tbody>${rows || "<tr><td colspan='3' class='muted'>Nenhuma inscrição ainda.</td></tr>"}</tbody>
          </table>
        `;
      } finally {
        isRefreshing = false;
        if (pendingRefresh) {
          pendingRefresh = false;
          queueMicrotask(loadPanel);
        }
      }
    }

    function startAutoRefresh() {
      pollingId = window.setInterval(() => {
        loadPanel();
      }, POLLING_MS);

      realtimeChannel = supabase
        .channel(`painel-evento-${eventId}`)
        .on(
          "postgres_changes",
          { event: "*", schema: "public", table: "registrations_checkin", filter: `event_id=eq.${eventId}` },
          () => loadPanel()
        )
        .on(
          "postgres_changes",
          { event: "UPDATE", schema: "public", table: "events", filter: `id=eq.${eventId}` },
          () => loadPanel()
        )
        .subscribe();
    }

    function stopAutoRefresh() {
      if (pollingId !== null) {
        window.clearInterval(pollingId);
        pollingId = null;
      }

      if (realtimeChannel) {
        supabase.removeChannel(realtimeChannel);
        realtimeChannel = null;
      }
    }

    window.addEventListener("beforeunload", stopAutoRefresh);

    await resolveEventIdBySlug();
    await loadPanel();
    startAutoRefresh();
  </script>
</body>
</html>
