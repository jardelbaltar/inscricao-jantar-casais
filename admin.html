<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin - Jantar de Casais</title>

<style>
:root {
  --bg: #0f172a;
  --surface: #ffffff;
  --text: #0f172a;
  --muted: #64748b;
  --primary: #7c3aed;
  --primary-hover: #6d28d9;
  --danger: #b91c1c;
  --secondary: #334155;
  --border: #e2e8f0;
  --shadow: 0 18px 45px rgba(15, 23, 42, 0.25);
  --radius: 18px;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  min-height: 100vh;
  padding: max(16px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(18px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left));
  font-family: "Inter", "Segoe UI", Roboto, Arial, sans-serif;
  color: var(--text);
  background: radial-gradient(circle at top right, #312e81 0%, var(--bg) 40%, #020617 100%);
}

.app { width: 100%; max-width: 1180px; margin: 0 auto; }

.hero {
  color: #f8fafc;
  text-align: center;
  margin-bottom: 14px;
}

.hero h1 {
  margin: 0;
  font-size: clamp(1.5rem, 3.5vw, 2rem);
  line-height: 1.2;
}

.hero p {
  margin: 8px 0 0;
  color: #cbd5e1;
}

.card {
  background: linear-gradient(160deg, #ffffff 0%, #f8fafc 100%);
  border: 1px solid rgba(148, 163, 184, 0.25);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 16px;
  margin-bottom: 14px;
}

h2 { margin: 0 0 8px; }

label {
  display: block;
  margin-top: 10px;
  font-size: 0.9rem;
  font-weight: 700;
  color: #334155;
}

input, select, button {
  display: block;
  width: 100%;
  min-height: 42px;
  margin-top: 6px;
  padding: 10px 12px;
  font-size: 15px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #fff;
  transition: border-color 0.2s, box-shadow 0.2s;
}

input:focus, select:focus {
  outline: none;
  border-color: color-mix(in srgb, var(--primary) 65%, white);
  box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.14);
}

button {
  margin-top: 14px;
  border: 0;
  background: linear-gradient(135deg, var(--primary) 0%, #2563eb 100%);
  color: #fff;
  font-weight: 700;
  cursor: pointer;
}

button:hover { filter: brightness(1.04); }
button.secondary { background: var(--secondary); }
button.danger { background: var(--danger); }
button.inline-btn {
  min-height: 34px;
  margin-top: 0;
  padding: 7px 10px;
  border-radius: 8px;
  font-size: 0.8rem;
}

.row { display: flex; gap: 10px; flex-wrap: wrap; }
.row > div { flex: 1; min-width: 180px; }

.panel-toggle {
  width: auto;
  min-height: 36px;
  margin-top: 0;
  padding: 8px 12px;
  font-size: 0.84rem;
  border-radius: 999px;
}

.event-open-toggle {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
  font-size: 0.9rem;
  font-weight: 700;
  color: #334155;
}

.event-open-toggle input {
  width: 18px;
  height: 18px;
  margin: 0;
  min-height: auto;
}

.dish-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

.dish-panel-body { margin-top: 12px; }

.inline-actions {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.inline-actions .inline-btn {
  width: auto;
}

.table-scroll { overflow-x: auto; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  min-width: 980px;
}

th, td {
  padding: 10px 8px;
  border-bottom: 1px solid #e2e8f0;
  text-align: left;
  vertical-align: middle;
}

th { color: #334155; font-size: 0.9rem; }

.status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
}

.status.confirmed { color: #166534; }
.status.waiting { color: #92400e; }

.inline-input {
  min-height: 34px;
  margin-top: 0;
  padding: 6px 8px;
  border-radius: 8px;
  font-size: 0.92rem;
}

#msg {
  margin-bottom: 10px;
  font-weight: 700;
  min-height: 24px;
  border-radius: 10px;
  padding: 8px 10px;
}

#msg:empty { padding: 0; margin-bottom: 0; }
.ok { color: #166534; background: #dcfce7; border: 1px solid #86efac; }
.err { color: #b91c1c; background: #fee2e2; border: 1px solid #fca5a5; }

.muted { color: var(--muted); }

@media (min-width: 680px) {
  body { padding: 30px 20px; }
  .card { padding: 22px; }
}
</style>
</head>

<body>
<main class="app">
  <section class="hero">
    <h1>Administração de Inscrições</h1>
    <p>Gerencie eventos, acompanhe a fila e edite dados dos casais.</p>
  </section>

  <div id="msg"></div>

  <div id="loginCard" class="card">
    <h2>Login</h2>
    <div class="row">
      <div>
        <label>Email</label>
        <input id="email" type="email" autocomplete="username">
      </div>
      <div>
        <label>Senha</label>
        <input id="password" type="password" autocomplete="current-password">
      </div>
    </div>
    <button id="btnLogin">Entrar</button>
  </div>

  <div id="app" style="display:none">
    <div class="card">
      <div class="row">
        <div>
          <h2>Evento</h2>
          <select id="eventSelect"></select>
        </div>
        <div>
          <label>Vagas</label>
          <input id="maxCouples" type="number" min="0">
        </div>
        <div>
          <label>Local</label>
          <input id="eventLocal">
          <label class="event-open-toggle" for="eventIsOpen">
            <input id="eventIsOpen" type="checkbox">
            <span>Inscrições abertas</span>
          </label>
        </div>
        <div style="align-self:flex-end">
          <button id="btnSaveEvent">Salvar</button>
        </div>
        <div style="align-self:flex-end">
          <button class="secondary" id="btnLogout">Sair</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="dish-panel-header">
        <div>
          <h2>Gestão de pratos</h2>
          <p class="muted" style="margin:4px 0 0;">Cadastre, reordene, ajuste quantidade e controle o status dos pratos.</p>
        </div>
        <button class="secondary panel-toggle" id="btnToggleDishPanel">Ocultar painel</button>
      </div>

      <div class="dish-panel-body" id="dishPanelBody">
        <div class="row">
          <div>
            <label>Nome do prato</label>
            <input id="newDishName" type="text" placeholder="Ex.: Filé ao molho madeira">
          </div>
          <div>
            <label>Ordem</label>
            <input id="newDishOrder" type="number" min="1" placeholder="1">
          </div>
          <div>
            <label>Quantidade</label>
            <input id="newDishQty" type="number" min="0" placeholder="50">
          </div>
          <div style="align-self:flex-end">
            <button id="btnAddDish">Cadastrar prato</button>
          </div>
        </div>
        <div id="dishesTableWrap"></div>
      </div>
    </div>

    <div class="card">
      <h2>Convidados</h2>
      <p class="muted">Edite diretamente os campos <strong>Nome do casal</strong> e <strong>Data de casamento</strong>.</p>
      <button class="secondary" id="btnPrintList">Imprimir lista de convidados</button>
      <div id="regsTableWrap"></div>
    </div>
  </div>
</main>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://nuqcefxwarrjehvhdoug.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51cWNlZnh3YXJyamVodmhkb3VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NzE1NzUsImV4cCI6MjA4NjM0NzU3NX0.xLugRmdl6UKVsMZnDepBlFndh4vGVMnptuloFZC28Mc";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
});

const msg = document.getElementById("msg");
const loginCard = document.getElementById("loginCard");
const app = document.getElementById("app");
const btnLogin = document.getElementById("btnLogin");
const btnLogout = document.getElementById("btnLogout");
const eventSelect = document.getElementById("eventSelect");
const maxCouples = document.getElementById("maxCouples");
const eventLocal = document.getElementById("eventLocal");
const eventIsOpen = document.getElementById("eventIsOpen");
const btnSaveEvent = document.getElementById("btnSaveEvent");
const btnPrintList = document.getElementById("btnPrintList");
const regsTableWrap = document.getElementById("regsTableWrap");
const btnToggleDishPanel = document.getElementById("btnToggleDishPanel");
const dishPanelBody = document.getElementById("dishPanelBody");
const newDishName = document.getElementById("newDishName");
const newDishOrder = document.getElementById("newDishOrder");
const newDishQty = document.getElementById("newDishQty");
const btnAddDish = document.getElementById("btnAddDish");
const dishesTableWrap = document.getElementById("dishesTableWrap");

let currentEventId = null;
let currentRegistrations = [];
let dishPanelCollapsed = false;

function setMsg(text, type = "") {
  msg.className = type;
  msg.textContent = text;
}

function escapeHtml(s) {
  return (s ?? "").toString().replace(/[&<>\"']/g, (c) => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[c]));
}

function maskPhone(phone) {
  const digits = (phone ?? "").replace(/\D/g, "");
  if (!digits) return "—";
  return `******${digits.slice(-4)}`;
}

function formatDate(value) {
  if (!value) return "—";
  const [y, m, d] = value.split("-");
  if (!y || !m || !d) return value;
  return `${d}/${m}/${y}`;
}

async function requireAdmin(session) {
  const { data } = await supabase
    .from("admins")
    .select("user_id")
    .eq("user_id", session.user.id)
    .maybeSingle();

  if (!data) throw new Error("NOT_ADMIN");
}

async function refreshEvents() {
  const params = new URLSearchParams(location.search);
  const urlEventSlug = params.get("event");

  const { data } = await supabase
    .from("events")
    .select("id,title,slug,event_at,max_couples,local,is_open,created_at")
    .order("created_at", { ascending: false });

  eventSelect.innerHTML = "";
  (data || []).forEach((e) => {
    const opt = document.createElement("option");
    opt.value = e.slug;
    opt.dataset.id = e.id;
    opt.textContent = e.title;
    opt.dataset.max = e.max_couples || 0;
    opt.dataset.local = e.local || "";
    opt.dataset.isOpen = e.is_open === false ? "false" : "true";
    eventSelect.appendChild(opt);
  });

  if (urlEventSlug && (data || []).some((x) => x.slug === urlEventSlug)) {
    eventSelect.value = urlEventSlug;
  }

  const selected = eventSelect.selectedOptions[0];
  if (!selected) {
    currentEventId = null;
    maxCouples.value = "";
    eventLocal.value = "";
    eventIsOpen.checked = false;
    regsTableWrap.innerHTML = "<p class='muted'>Nenhum evento cadastrado.</p>";
    return;
  }

  currentEventId = eventSelect.selectedOptions[0]?.dataset.id || null;
  maxCouples.value = selected.dataset.max;
  eventLocal.value = selected.dataset.local;
  eventIsOpen.checked = selected.dataset.isOpen !== "false";
}

async function normalizeQueuePos(rows) {
  const updates = [];

  rows.forEach((row, idx) => {
    const nextPos = idx + 1;
    if (Number(row.queue_pos) !== nextPos) {
      updates.push(
        supabase
          .from("registrations")
          .update({ queue_pos: nextPos })
          .eq("id", row.id)
      );
      row.queue_pos = nextPos;
    }
  });

  if (updates.length) {
    await Promise.all(updates);
  }
}

async function updateRegistrationField(id, patch) {
  const { error } = await supabase
    .from("registrations")
    .update(patch)
    .eq("id", id);

  if (error) {
    setMsg("Erro ao salvar alteração.", "err");
    return false;
  }

  setMsg("Alteração salva.", "ok");
  return true;
}

async function refreshRegistrations() {
  if (!currentEventId) {
    regsTableWrap.innerHTML = "<p class='muted'>Selecione um evento para carregar as inscrições.</p>";
    return;
  }

  const { data } = await supabase
    .from("registrations")
    .select("id,couple_name,wedding_date,phone,queue_pos,dishes(name)")
    .eq("event_id", currentEventId)
    .order("queue_pos", { ascending: true })
    .order("id", { ascending: true });

  const rows = data || [];
  currentRegistrations = rows;
  await normalizeQueuePos(rows);

  const limit = Number(maxCouples.value || 0);

  const html = rows.map((r, idx) => {
    const confirmed = limit > 0 ? idx < limit : true;
    const statusText = confirmed ? "Confirmado" : "Lista de espera";
    const statusClass = confirmed ? "confirmed" : "waiting";

    return `
<tr>
  <td><span class="status ${statusClass}">${confirmed ? "✅" : "⏳"} ${statusText}</span></td>
  <td>${r.queue_pos ?? idx + 1}</td>
  <td>
    <input class="inline-input js-inline" data-id="${r.id}" data-field="couple_name" type="text" value="${escapeHtml(r.couple_name ?? "")}" />
  </td>
  <td>
    <input class="inline-input js-inline" data-id="${r.id}" data-field="wedding_date" type="date" value="${escapeHtml(r.wedding_date ?? "")}" />
  </td>
  <td>${escapeHtml(maskPhone(r.phone))}</td>
  <td>${escapeHtml(r.dishes?.name ?? "—")}</td>
  <td>
    <button data-id="${r.id}" class="danger inline-btn btnDelete">Excluir</button>
  </td>
</tr>`;
  }).join("");

  regsTableWrap.innerHTML = `
<div class="table-scroll">
  <table>
    <thead>
      <tr>
        <th>Status da inscrição</th>
        <th>Ordem</th>
        <th>Nome do casal</th>
        <th>Data de casamento</th>
        <th>Telefone (anonimizado)</th>
        <th>Prato escolhido</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>${html || "<tr><td colspan='7' class='muted'>Nenhuma inscrição ainda.</td></tr>"}</tbody>
  </table>
</div>`;

  document.querySelectorAll(".js-inline").forEach((input) => {
    const commit = async () => {
      const id = input.dataset.id;
      const field = input.dataset.field;
      const value = field === "wedding_date" && !input.value ? null : input.value.trim();
      const ok = await updateRegistrationField(id, { [field]: value || null });
      if (ok) {
        input.dataset.lastValue = input.value;
      }
    };

    input.dataset.lastValue = input.value;

    input.addEventListener("change", commit);
    input.addEventListener("keydown", async (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        input.blur();
      }
    });
    input.addEventListener("blur", async () => {
      if (input.value === input.dataset.lastValue) return;
      await commit();
    });
  });

  document.querySelectorAll(".btnDelete").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      await supabase.from("registrations").delete().eq("id", id);
      setMsg("Inscrição excluída.", "ok");
      refreshRegistrations();
    });
  });
}

function getDishFormValuesById(id) {
  return {
    name: document.querySelector(`.js-dish-name[data-id="${id}"]`)?.value.trim() || "",
    sortOrder: Number(document.querySelector(`.js-dish-order[data-id="${id}"]`)?.value || 0),
    remaining: Number(document.querySelector(`.js-dish-qty[data-id="${id}"]`)?.value || 0)
  };
}

async function refreshDishes() {
  if (!currentEventId) {
    dishesTableWrap.innerHTML = "<p class='muted'>Selecione um evento para gerenciar os pratos.</p>";
    return;
  }

  const { data, error } = await supabase
    .from("dishes")
    .select("id,name,sort_order,remaining,is_active,created_at")
    .eq("event_id", currentEventId)
    .order("sort_order", { ascending: true })
    .order("created_at", { ascending: true });

  if (error) {
    dishesTableWrap.innerHTML = "<p class='err'>Erro ao carregar pratos.</p>";
    return;
  }

  const rows = (data || []).map((dish) => `
<tr>
  <td><input class="inline-input js-dish-name" data-id="${dish.id}" type="text" value="${escapeHtml(dish.name ?? "")}" /></td>
  <td><input class="inline-input js-dish-order" data-id="${dish.id}" type="number" min="1" value="${dish.sort_order ?? ""}" /></td>
  <td><input class="inline-input js-dish-qty" data-id="${dish.id}" type="number" min="0" value="${dish.remaining ?? 0}" /></td>
  <td>${dish.is_active ? "✅ Ativo" : "⏸️ Inativo"}</td>
  <td>
    <div class="inline-actions">
      <button class="secondary inline-btn btnSaveDish" data-id="${dish.id}">Salvar</button>
      <button class="inline-btn btnToggleDish" data-id="${dish.id}" data-active="${dish.is_active}">${dish.is_active ? "Desativar" : "Ativar"}</button>
      <button class="danger inline-btn btnDeleteDish" data-id="${dish.id}">Excluir</button>
    </div>
  </td>
</tr>`).join("");

  dishesTableWrap.innerHTML = `
<div class="table-scroll">
  <table>
    <thead>
      <tr>
        <th>Prato</th>
        <th>Ordem</th>
        <th>Quantidade</th>
        <th>Status</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>${rows || "<tr><td colspan='5' class='muted'>Nenhum prato cadastrado.</td></tr>"}</tbody>
  </table>
</div>`;

  document.querySelectorAll(".btnSaveDish").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      const values = getDishFormValuesById(id);
      if (!values.name) {
        setMsg("Informe o nome do prato.", "err");
        return;
      }

      const { error: updateError } = await supabase
        .from("dishes")
        .update({
          name: values.name,
          sort_order: Math.max(1, values.sortOrder || 1),
          remaining: Math.max(0, values.remaining || 0)
        })
        .eq("id", id);

      if (updateError) {
        setMsg("Erro ao atualizar prato.", "err");
        return;
      }

      setMsg("Prato atualizado.", "ok");
      await refreshDishes();
    });
  });

  document.querySelectorAll(".btnToggleDish").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      const isActive = btn.dataset.active === "true";
      const { error: toggleError } = await supabase
        .from("dishes")
        .update({ is_active: !isActive })
        .eq("id", id);

      if (toggleError) {
        setMsg("Erro ao alterar status do prato.", "err");
        return;
      }

      setMsg(`Prato ${!isActive ? "ativado" : "desativado"}.`, "ok");
      await refreshDishes();
    });
  });

  document.querySelectorAll(".btnDeleteDish").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      const { error: deleteError } = await supabase
        .from("dishes")
        .delete()
        .eq("id", id);

      if (deleteError) {
        setMsg("Erro ao excluir prato. Verifique se há inscrições vinculadas.", "err");
        return;
      }

      setMsg("Prato excluído.", "ok");
      await refreshDishes();
    });
  });
}

function syncDishPanelState() {
  dishPanelBody.style.display = dishPanelCollapsed ? "none" : "";
  btnToggleDishPanel.textContent = dishPanelCollapsed ? "Mostrar painel" : "Ocultar painel";
}

function openGuestListForPrint() {
  if (!currentEventId) {
    setMsg("Selecione um evento para imprimir.", "err");
    return;
  }

  if (!currentRegistrations.length) {
    setMsg("Não há convidados para imprimir.", "err");
    return;
  }

  const selectedEvent = eventSelect.selectedOptions[0];
  const eventTitle = selectedEvent?.textContent?.trim() || "Evento";
  const eventLocalValue = eventLocal.value?.trim() || selectedEvent?.dataset.local || "Não informado";
  const eventMaxValue = Number(maxCouples.value || selectedEvent?.dataset.max || 0);

  const rowsHtml = currentRegistrations.map((r, idx) => `
    <tr>
      <td>${r.queue_pos ?? idx + 1}</td>
      <td>${escapeHtml(r.couple_name || "—")}</td>
      <td>${escapeHtml(formatDate(r.wedding_date))}</td>
      <td>${escapeHtml(r.phone || "—")}</td>
      <td>${escapeHtml(r.dishes?.name || "—")}</td>
    </tr>
  `).join("");

  const printWindow = window.open("", "_blank");
  if (!printWindow) {
    setMsg("Não foi possível abrir a aba de impressão. Verifique o bloqueador de pop-up.", "err");
    return;
  }

  printWindow.document.write(`<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Lista de convidados - ${escapeHtml(eventTitle)}</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; color: #0f172a; }
    h1 { margin: 0 0 14px; font-size: 24px; }
    .event-data { margin-bottom: 18px; }
    .event-data p { margin: 4px 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #cbd5e1; padding: 8px; text-align: left; font-size: 14px; }
    th { background: #f1f5f9; }
    @media print { body { margin: 10mm; } }
  </style>
</head>
<body>
  <h1>Lista de convidados</h1>
  <div class="event-data">
    <p><strong>Evento:</strong> ${escapeHtml(eventTitle)}</p>
    <p><strong>Local:</strong> ${escapeHtml(eventLocalValue)}</p>
    <p><strong>Vagas:</strong> ${eventMaxValue > 0 ? eventMaxValue : "Não definido"}</p>
    <p><strong>Total de convidados:</strong> ${currentRegistrations.length}</p>
  </div>
  <table>
    <thead>
      <tr>
        <th>Ordem</th>
        <th>Nome do casal</th>
        <th>Data de casamento</th>
        <th>Telefone</th>
        <th>Prato escolhido</th>
      </tr>
    </thead>
    <tbody>${rowsHtml}</tbody>
  </table>

  <script>
    window.onload = () => {
      window.print();
    };
  <\/script>
</body>
</html>`);
  printWindow.document.close();
  setMsg("Lista aberta em nova aba para impressão.", "ok");
}

btnLogin.addEventListener("click", async () => {
  setMsg("");
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) {
    setMsg("Erro no login", "err");
    return;
  }

  try {
    await requireAdmin(data.session);
    loginCard.style.display = "none";
    app.style.display = "";
    await refreshEvents();
    await refreshDishes();
    await refreshRegistrations();
  } catch {
    await supabase.auth.signOut();
    setMsg("Usuário não autorizado", "err");
  }
});

btnLogout.addEventListener("click", async () => {
  await supabase.auth.signOut();
  loginCard.style.display = "";
  app.style.display = "none";
});

eventSelect.addEventListener("change", async () => {
  currentEventId = eventSelect.selectedOptions[0]?.dataset.id || null;
  maxCouples.value = eventSelect.selectedOptions[0].dataset.max;
  eventLocal.value = eventSelect.selectedOptions[0].dataset.local;
  eventIsOpen.checked = eventSelect.selectedOptions[0].dataset.isOpen !== "false";
  await refreshDishes();
  refreshRegistrations();
});

btnToggleDishPanel.addEventListener("click", () => {
  dishPanelCollapsed = !dishPanelCollapsed;
  syncDishPanelState();
});

btnAddDish.addEventListener("click", async () => {
  if (!currentEventId) {
    setMsg("Selecione um evento para cadastrar pratos.", "err");
    return;
  }

  const name = newDishName.value.trim();
  const sortOrder = Math.max(1, Number(newDishOrder.value || 1));
  const remaining = Math.max(0, Number(newDishQty.value || 0));

  if (!name) {
    setMsg("Informe o nome do prato.", "err");
    return;
  }

  const { error } = await supabase
    .from("dishes")
    .insert({
      event_id: currentEventId,
      name,
      sort_order: sortOrder,
      remaining,
      is_active: true
    });

  if (error) {
    setMsg("Erro ao cadastrar prato.", "err");
    return;
  }

  newDishName.value = "";
  newDishOrder.value = "";
  newDishQty.value = "";
  setMsg("Prato cadastrado.", "ok");
  await refreshDishes();
});

btnSaveEvent.addEventListener("click", async () => {
  await supabase.from("events")
    .update({
      max_couples: Number(maxCouples.value || 0),
      local: eventLocal.value || null,
      is_open: eventIsOpen.checked
    })
    .eq("id", currentEventId);

  const selected = eventSelect.selectedOptions[0];
  if (selected) {
    selected.dataset.max = maxCouples.value || 0;
    selected.dataset.local = eventLocal.value || "";
    selected.dataset.isOpen = eventIsOpen.checked ? "true" : "false";
  }

  setMsg("Evento atualizado.", "ok");
  refreshRegistrations();
});

btnPrintList.addEventListener("click", openGuestListForPrint);

(async () => {
  const { data } = await supabase.auth.getSession();
  if (data.session) {
    try {
      await requireAdmin(data.session);
      loginCard.style.display = "none";
      app.style.display = "";
      await refreshEvents();
      await refreshDishes();
      await refreshRegistrations();
    } catch {
      await supabase.auth.signOut();
    }
  }
})();

syncDishPanelState();
</script>
</body>
</html>
